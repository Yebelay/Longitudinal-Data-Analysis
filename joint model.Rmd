---
title: |
     <span style="color:white">  Joint Modeling of Longitudinal and Survival Outcomes </span>

author: <span style="color:#38BDDE"> Anteneh Tesema and Yebelay Berehan </span>
  
institute: |
           <span style = 'font-size: 80%;'>  Ethiopian Public Health Institute (EPHI) 
           National Data Management Center for Health (NDMC)</span>
           
date: |
      <span style = 'font-size: 50%;'> August 24-27, 2023
      
output:
  xaringan::moon_reader:
    css: [default,  xaringan-themer.css, rladies-fonts]
    nature:
     # highlightStyle: googlecode
      highlightLines: true
      #highlightLanguage: ["r"]
      ratio: "14:9"
      highlightSpans: true
      highlightStyle: github
      countIncrementalSlides: false
      titleSlideClass: ["center","middle"]
  includes:
    in_header: columns.tex
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(here)
library(snakecase)
library(DT)
library(naniar)
#library(kableExtra)
```

```{r xaringan-logo, echo=FALSE}
xaringanExtra::use_logo(image_url = "Slides/Images/tidyverse.png", width = "95px",height = "95px")
```

```{r xaringan-themer, include=FALSE}
library(xaringanthemer)
mono_light(
  base_color =  "#151B54", ## OHSU Marquam
  text_color = "#2F539B",
 # "#0000A5",
  base_font_size ="22px",
  code_highlight_color = "#c0e8f5",
  link_color = "#38BDDE",
  background_color = "#FFFFFF",
  header_font_google = google_font("Josefin Sans"),
  #text_font_google   = google_font("Montserrat", "300", "300i","400i","700"),
  code_font_family = "'Source Code Pro'",
  code_font_size = "0.7em",
  text_slide_number_color = "#FF0266",
  code_inline_color = "#0000FF",
  #inverse_background_color = "#272822",
  #title_slide_background_color = inverse_background_color,
 # code_font_size = "0.6em", 
  footnote_color = "blue",
  #footnote_position_bottom = "0.1em"
  )
```


Exploratory Data Analysis (EDA) for longitudinal data involves 
  * understanding and analyzing patterns, 
  * trends, and 
  * relationships within data that is collected over time from the same subjects or entities. 

- A step-by-step guide to conducting EDA for longitudinal data:

**1. Data Understanding and Preparation:**
   - Familiarize yourself with the data's structure, including the variables, time points, and units of observation.
   
   - Identify missing values, outliers, and potential data quality issues. Consider how missing data might affect your analysis and choose appropriate strategies to handle it.
   - Organize the data in a format that facilitates analysis, such as a wide or long format.

---

**2. Visualization:**
   - Use line plots or scatter plots to visualize the trajectory of each subject/entity over time. This can help identify overall trends, fluctuations, and potential outliers.
   - Create a time series plot to observe how the variables change over time for individual subjects.
   - Construct box plots or violin plots to visualize the distribution of measurements at different time points.
   - Create heatmaps to visualize correlations between different time points.

**3. Descriptive Statistics:**
   - Calculate summary statistics (mean, median, standard deviation, etc.) for each time point to understand central tendencies and variability.
   - Compute descriptive statistics separately for different groups or conditions if relevant.

**4. Trends and Patterns:**
   - Identify trends, cycles, or patterns in the data. Look for increasing, decreasing, or cyclic behaviors over time.
   - Consider using moving averages or other smoothing techniques to visualize underlying trends.

**5. Comparisons:**
   - Compare groups or conditions to see how they differ in terms of their trajectories over time.
   - Conduct subgroup analysis to explore whether different subgroups exhibit distinct patterns.

---

**6. Correlation and Causation:**
   - Explore correlations between variables at different time points. Use correlation matrices or scatter plots to visualize these relationships.
   - Be cautious about inferring causation from correlations, as other factors could be at play.

**7. Modeling and Forecasting:**
   - Consider time series modeling techniques to capture and forecast the underlying patterns in the data.
   - Techniques like autoregressive integrated moving average (ARIMA), exponential smoothing, or more advanced models like state space models can be useful.

**8. Change Point Detection:**
   - Use change point detection methods to identify shifts in the trajectory of the data. This can be especially useful when analyzing longitudinal data to identify when significant changes occur.

**9. Interactive Visualization:**
   - Consider using interactive visualization tools to allow users to explore the data more dynamically. Tools like Plotly or Tableau can be helpful.

**10. Domain Knowledge Integration:**
   - Incorporate your domain knowledge to interpret the findings and validate the insights derived from the EDA.

---

Remember, longitudinal data analysis requires careful consideration of the temporal nature of the data and the potential biases and challenges associated with it. 

- Always tailor your EDA techniques to the specific characteristics of your data and research objectives.

---

- Let's work with the **sleepstudy** dataset available in the "lme4" package. 

- This dataset contains information about reaction times for subjects in a sleep deprivation study. 

- We'll use this dataset to perform some exploratory data analysis (EDA) steps for longitudinal data analysis.

```{r, message=FALSE, warning=FALSE}
# Load necessary libraries
library(lme4)
library(ggplot2)
library(dplyr)

# Load the sleepstudy dataset
data("sleepstudy")
sleep_data <- sleepstudy
# Step 1: Data Understanding and Preparation
# The sleepstudy dataset includes 'Subject', 'Days', and 'Reaction' columns
```

---

```{r, message=FALSE, warning=FALSE, fig.align='center', fig.height=5}
# Line plot for individual subject's reaction time trajectory over days
ggplot(sleep_data, aes(x = Days, y = Reaction, color = factor(Subject))) +
  geom_line() +
  labs(x = "Days", y = "Reaction Time", title = "Reaction Time Over Days")
```

- Line Plot: The line plot of individual subject's reaction time trajectory over days shows how reaction times change over the study period. 
- Some subjects appear to have a decreasing trend in reaction time, while others show fluctuations.
---

```{r, message=FALSE, warning=FALSE, fig.align='center', fig.height=5}
# Box plot to visualize the distribution of reaction times at different days
ggplot(sleep_data, aes(x = factor(Days), y = Reaction)) +
  geom_boxplot() +
  labs(x = "Days", y = "Reaction Time", title = "Distribution of Reaction Times")
```
- Box Plot: The box plot provides a visual summary of the distribution of reaction times at different days. 
   - It highlights the central tendency, spread, and potential outliers in the data.
---
```{r, message=FALSE, warning=FALSE}
# Summary statistics for each day
summary_by_day <- sleep_data %>%
  group_by(Days) %>%
  summarize(mean_reaction = mean(Reaction),
            median_reaction = median(Reaction),
            sd_reaction = sd(Reaction))
summary_by_day

with(sleep_data,tapply(Reaction,list(Days),mean,na.rm=TRUE))
```

- The summary statistics by day reveal the average, median, and standard deviation of reaction times on each day. These statistics give an overview of the data's central tendency and variability over time.

---
```{r, message=FALSE, warning=FALSE, fig.align='center', fig.height=5}
# Trend line using moving average
sleep_data %>%
  group_by(Subject) %>%
  arrange(Days) %>%
  mutate(moving_avg = zoo::rollmean(Reaction, k = 5, fill = NA, align = "right")) %>%
  ggplot(aes(x = Days, y = moving_avg, color = factor(Subject))) +
  geom_line() +
  labs(x = "Days", y = "Moving Average Reaction Time", title = "Moving Average Reaction Time")
```

- Trend Line: The moving average trend line for individual subjects smoothes out the fluctuations in reaction time and highlights potential trends. 
- It helps identify general patterns in reaction time changes over days.

---

```{r, message=FALSE, warning=FALSE, fig.align='center', fig.height=5}
# Comparing reaction time trajectories between different subjects
ggplot(sleep_data, aes(x = Days, y = Reaction, color = factor(Subject))) +
  geom_line() +
  labs(x = "Days", y = "Reaction Time", title = "Reaction Time Comparison by Subject")
```

- Reaction Time Comparison: The comparison of reaction time trajectories between different subjects helps identify variations in the way subjects respond to sleep deprivation. Some subjects might be more affected than others.

---

```{r, message=FALSE, warning=FALSE, fig.align='center', fig.height=5}
# Using Plotly for interactive line plot
library(plotly)
plot_ly(sleep_data, x = ~Days, y = ~Reaction, color = ~factor(Subject), type = "scatter", mode = "lines")
```

- Interactive Line Plot: The interactive line plot using Plotly allows users to explore the reaction time data for each subject over days more dynamically. 
- Users can hover over points to see specific values.

---

- Exploratory Data Analysis (EDA) can guide you in choosing appropriate models for analyzing longitudinal data, such as linear mixed models or marginal models. 

- EDA helps you understand the underlying patterns, trends, and characteristics of the data, which can inform your decision-making process when selecting a suitable modeling approach. 

- Here's how EDA can influence your choice of models:

**1. Identifying Patterns and Trends:**

- EDA can reveal whether there are consistent patterns and trends in the data across time points or within subjects. 

- If there are clear trends or patterns, a linear mixed-effects model might be appropriate to capture both fixed effects (population-level trends) and random effects (individual variations).
---

**2. Variability and Correlations:**
- EDA can help you understand the variability in response within and between subjects. 

- If there is significant variability between subjects and possible correlations within subjects, a linear mixed-effects model can account for these variations through random effects.

**3. Group Comparisons:**
- If your EDA shows distinct trajectories or group differences, a linear mixed-effects model can incorporate interaction terms to capture how different groups respond differently over time.

---

**4. Repeated Measures and Time Dependency:**
- EDA can highlight the extent of time dependency and autocorrelation in the data. 
- If measurements at different time points are correlated, it suggests the use of models that account for time dependencies, such as linear mixed-effects models.

**5. Model Flexibility:**
- If your EDA shows complex non-linear relationships or varying slopes over time, more flexible models such as nonlinear mixed-effects models might be considered.

---

**6. Handling Missing Data:**
- EDA can reveal patterns of missing data. 
- If missing data is correlated with certain variables or time points, it's important to choose a model that can handle missing data appropriately.

**7. Model Assumptions:**
- EDA can provide insights into the distribution of residuals, helping you assess whether model assumptions (e.g., normality, homoscedasticity) are met. 
- If assumptions are violated, you might need to consider transformations or alternative models.

---

**8. Trade-offs between Complexity and Interpretability:**
- Based on your EDA, you can evaluate the trade-offs between model complexity and interpretability. 
- More complex models might fit the data better but could be harder to interpret.

In summary, EDA guides your choice of models by helping you understand the data's structure, patterns, and relationships. Linear mixed-effects models are often preferred for longitudinal data due to their ability to handle correlated observations, individual variations, and repeated measures. However, the decision also depends on your research objectives, the assumptions of the models, and your familiarity with the chosen modeling approach. EDA provides a crucial foundation for making informed decisions in selecting the most appropriate modeling strategy for your longitudinal data analysis.

---

```{r}
# Load necessary libraries
library(lme4)
library(GGally)

# Load the sleepstudy dataset
data("sleepstudy")
sleep_data <- sleepstudy

# Create a scatter plot matrix
scatterplot_matrix <- ggpairs(sleep_data, columns = c("Days", "Reaction"),
                               lower = list(continuous = wrap("points")),
                               upper = list(continuous = wrap("cor", method = "pearson")))

# Display the scatter plot matrix
print(scatterplot_matrix)

```

```{r}
# Load necessary libraries
library(lme4)
library(tidyr)

# Load the sleepstudy dataset
data("sleepstudy")
sleep_data <- sleepstudy

# Reshape the data using pivot_wider
reshaped_data <- sleep_data %>%
  pivot_wider(names_from = Days, values_from = Reaction, names_prefix = "Day_")

# Display the reshaped data
head(reshaped_data)

```
```{r}
attach(sleepstudy)
d1<-Reaction[Days==0]
d2<-Reaction[Days==1]
d3<-Reaction[Days==2]
d4<-Reaction[Days==3]
d5<-Reaction[Days==4]
d6<-Reaction[Days==5]
d7<-Reaction[Days==6]
d8<-Reaction[Days==7]
d9<-Reaction[Days==8]
d10<-Reaction[Days==9]
response1<-cbind(d1, d2, d3, d4, d5, d6, d7, d8, d9, d10)
df <- as.data.frame(response1)
df %>% ggpairs(.,
               columns = 2:4, 
               diag = list(continuous = wrap("barDiag", bins = 10, fill = "cyan")))
               #lower = list(continuous = wrap(lower_plots, color="red", se=F))) 
```


